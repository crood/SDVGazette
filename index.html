<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stardew Valley Gazette</title>
    
    <!-- Tailwind CSS for layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked Library for parsing Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts: VT323 for that pixel-art look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">

    <style>
        :root {
            --sdv-cream: #fdf2d8;
            --sdv-border: #804022;
            --sdv-border-light: #b87030;
            --sdv-blue: #0088ff;
            --sdv-paper: #fffdf5;
            --sdv-text: #4a2e18;
            --sdv-dark-bg: #5d3a1a;
        }

        body {
            background-color: #ffdcae;
            background-image: 
                radial-gradient(#ffce94 15%, transparent 16%),
                radial-gradient(#ffce94 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            font-family: 'VT323', monospace;
            color: var(--sdv-text);
            overflow-y: scroll; /* Prevent layout shift */
        }

        /* --- UI COMPONENTS --- */

        /* The Classic SDV Box Border */
        .sdv-box {
            background-color: var(--sdv-cream);
            border: 4px solid var(--sdv-border);
            box-shadow: 
                inset 4px 4px 0px var(--sdv-border-light),
                inset -4px -4px 0px #cf9d69,
                4px 4px 0px rgba(0,0,0,0.2);
            position: relative;
        }
        /* Corner pixels */
        .sdv-box::before { content: ''; position: absolute; top: -4px; left: -4px; width: 4px; height: 4px; background: #ffdcae; box-shadow: 4px 0 var(--sdv-border), 0 4px var(--sdv-border); z-index: 1; }
        .sdv-box::after { content: ''; position: absolute; bottom: -4px; right: -4px; width: 4px; height: 4px; background: #ffdcae; box-shadow: -4px 0 var(--sdv-border), 0 -4px var(--sdv-border); z-index: 1; }

        /* Dark Box (for sidebar headers/buttons) */
        .sdv-box-dark {
            background-color: var(--sdv-dark-bg);
            color: #fdf2d8;
            border: 4px solid #3d2310;
            padding: 0.5rem 1rem;
            position: relative;
        }

        /* Header Typography */
        h1, h2, h3 { text-transform: uppercase; letter-spacing: 1px; }
        
        .header-title {
            text-shadow: 4px 4px 0px #e0c095;
            font-size: 5rem;
            line-height: 0.8;
            color: #5d1616;
            margin-bottom: 0.5rem;
        }
        .header-subtitle {
            border-top: 3px solid var(--sdv-border);
            border-bottom: 3px solid var(--sdv-border);
            padding: 0.5rem 0;
            font-style: italic;
            color: var(--sdv-text);
        }

        /* Input Fields */
        .input-sdv {
            background: #fff;
            border: 3px solid var(--sdv-border);
            padding: 5px 10px;
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            color: var(--sdv-text);
            outline: none;
            width: 100%;
        }
        .input-sdv:focus { background: #fffdf5; border-color: var(--sdv-border-light); }

        /* Buttons */
        .btn-sdv {
            background: #e69d50;
            border: 3px solid #570e0e;
            color: #570e0e;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 1.5rem;
            padding: 0.25rem 1rem;
            transition: all 0.1s;
        }
        .btn-sdv:hover { background: #ffb86c; transform: translateY(-2px); }
        .btn-sdv:active { transform: translateY(2px); }

        /* --- ARTICLE STYLING --- */

        .article-card {
            background-color: var(--sdv-paper);
            border: 2px solid var(--sdv-border-light);
            padding: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%; /* Full height for grid */
            display: flex;
            flex-direction: column;
        }
        
        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 0px rgba(93, 58, 26, 0.3);
            border-color: var(--sdv-border);
        }

        .article-poster-container {
            border: 4px solid var(--sdv-border);
            margin-bottom: 1rem;
            overflow: hidden;
            background: #5d3a1a;
        }

        .article-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
            image-rendering: pixelated;
            transition: transform 0.3s;
        }
        .article-card:hover .article-poster { transform: scale(1.05); }

        .article-content-preview {
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 6; /* Show max 6 lines in preview */
            -webkit-box-orient: vertical;
        }

        .newspaper-date {
            border-top: 2px dashed var(--sdv-border-light);
            margin-top: 1rem;
            padding-top: 0.5rem;
            font-size: 1.1rem;
            text-align: right;
            color: #7c5c40;
            font-style: italic;
        }

        /* Markdown Styles */
        .markdown-body h1 { font-size: 1.8rem; color: #5d1616; margin-bottom: 0.5rem; line-height: 1.1; }
        .markdown-body p { margin-bottom: 0.8rem; font-size: 1.25rem; line-height: 1.3; }
        .markdown-body strong { color: #802015; }

        /* --- MODAL --- */
        #articleModal { backdrop-filter: blur(2px); }
        .modal-content img { max-width: 100%; border: 4px solid var(--sdv-border); margin-bottom: 1rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #e0c095; }
        ::-webkit-scrollbar-thumb { background: #804022; border: 2px solid #e0c095; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- HEADER -->
        <header class="text-center mb-12">
            <div class="border-b-4 border-[#5d3a1a] pb-2 mb-2">
                <div class="flex justify-between items-end text-sm md:text-xl font-bold text-[#5d3a1a] px-2 mb-1 uppercase tracking-widest">
                    <span>Vol. LXIV ... No. 12</span>
                    <span>Pelican Town, SDV</span>
                    <span>Price: 100g</span>
                </div>
                <h1 class="header-title">The Stardew Valley Gazette</h1>
            </div>
            <div class="header-subtitle text-xl md:text-2xl text-center">
                "The Heart of the Valley, Delivered to Your Porch"
            </div>
        </header>

        <!-- MAIN LAYOUT: GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <!-- LEFT COLUMN: ARTICLES (3/4 Width) -->
            <div class="lg:col-span-3">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl text-[#5d3a1a]" id="currentViewTitle">Latest News</h2>
                </div>

                <!-- Article Grid -->
                <div id="news-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-1 md:col-span-2 text-center text-2xl animate-pulse mt-12">
                        Waitin' for the paper boy...
                    </div>
                </div>

                <!-- Pagination Button -->
                <div class="mt-12 text-center">
                    <button id="loadMoreBtn" class="btn-sdv hidden w-full md:w-auto px-12 py-3">
                        Read Archive
                    </button>
                    <p id="endMessage" class="hidden text-xl mt-4 text-[#804022] opacity-70">- End of Archives -</p>
                </div>
            </div>

            <!-- RIGHT COLUMN: SIDEBAR (1/4 Width) -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Search Widget -->
                <div class="sdv-box p-4">
                    <div class="sdv-box-dark mb-4 text-center">Search Archive</div>
                    <input type="text" id="searchInput" placeholder="Keywords..." class="input-sdv">
                </div>

                <!-- Filter Widget -->
                <div class="sdv-box p-4">
                    <div class="sdv-box-dark mb-4 text-center">Filter Month</div>
                    <select id="monthFilter" class="input-sdv cursor-pointer">
                        <option value="all">All Months</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <!-- Weather Widget -->
                <div class="sdv-box p-0 overflow-hidden">
                    <div class="sdv-box-dark text-center border-none">Weather Forecast</div>
                    <div class="p-4 bg-[#4a2e18] text-[#fdf2d8] flex flex-col items-center text-center">
                        <div class="text-6xl mb-2">☀️</div>
                        <p class="leading-tight text-lg">Sunny with a chance of Junimos. Don't forget to water your parsnips!</p>
                    </div>
                </div>

                <!-- Notice Widget -->
                <div class="sdv-box p-4 bg-[#fffdf5]">
                    <div class="border-2 border-dashed border-[#b87030] p-3 text-center">
                        <h3 class="text-xl text-[#802015] mb-2 font-bold">NOTICE</h3>
                        <p class="text-lg leading-tight">
                            If you see a shadowy figure near the bus stop, please notify the Adventurer's Guild immediately.
                        </p>
                    </div>
                </div>

                <!-- Help/Upload Tip -->
                <div class="opacity-70 text-center text-sm border-t-2 border-[#b87030] pt-4">
                    <p class="font-bold uppercase mb-1">Brought to you by Zuzu Print Inc.</p>
                    <!-- <p>Place <code>news-x.md</code> files in this folder to publish.</p> -->
                </div>

            </div>
        </div>

    </div>

    <!-- MODAL FOR READING FULL ARTICLE -->
    <div id="articleModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4">
        <div class="sdv-box w-full max-w-3xl max-h-[90vh] flex flex-col relative shadow-2xl">
            <!-- Modal Header -->
            <div class="flex justify-end p-2 bg-[#fdf2d8] border-b-2 border-[#b87030]">
                <button id="closeModalBtn" class="btn-sdv text-sm py-1 px-3">Close X</button>
            </div>
            
            <!-- Modal Content (Scrollable) -->
            <div id="modalContent" class="p-8 overflow-y-auto bg-[#fffdf5] markdown-body">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <script>
        /**
         * CONFIGURATION
         */
        const USE_DEMO_MODE = false; 
        const FILE_PREFIX = "news-"; // Looks for news-1.md, news-2.md...

        // ---------------------------------------------------------

        const container = document.getElementById('news-container');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const endMessage = document.getElementById('endMessage');
        const searchInput = document.getElementById('searchInput');
        const monthFilter = document.getElementById('monthFilter');
        const modal = document.getElementById('articleModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const currentViewTitle = document.getElementById('currentViewTitle');

        // State
        let allArticles = [];
        let availableMonths = [];
        let visibleMonthsCount = 1; // Number of months to show in pagination mode
        let currentFilterMonth = "all";
        let currentSearchTerm = "";

        // Demo Data
        function getDemoData() {
            return [
                {
                    filename: 'demo1.md',
                    content: `---
date: 2026-02-14
poster: https://placehold.co/600x300/5d3a1a/FFF?text=Crop+Fairy
---
# The Crop Fairy Visits!

The farm was blessed last night! I woke up to find my **Cauliflowers** completely grown. 

It seems the spirits are pleased with the recent offerings at the Community Center. Time to harvest!`
                },
                {
                    filename: 'demo2.md',
                    content: `---
date: 2026-02-02
poster: https://placehold.co/600x300/2a5d3a/FFF?text=New+Barn
---
# Barn Construction Complete

Robin finished the **Big Barn** today. 

It took 3 days of hammering and sawing, but the cows finally have a proper home. The goats seem indifferent, but that is to be expected.`
                },
                {
                    filename: 'demo3.md',
                    content: `---
date: 2026-01-28
poster: https://placehold.co/600x300/804022/FFF?text=Grandpa
---
# A Letter from Grandpa?

Found an old note in the shrine today. It was dusty and smelled like parsnips. 

*"Wait for my return at the dawn of the third year."*

Spooky stuff.`
                }
            ];
        }

        /**
         * 1. PARSING LOGIC
         */
        function parseArticle(rawText, filename) {
            if (typeof marked === 'undefined') {
                return {
                    body: "Error: Markdown library failed to load.", 
                    date: "2000-01-01", 
                    filename 
                };
            }

            const frontmatterRegex = /^---\s*[\r\n]+([\s\S]*?)[\r\n]+---/;
            const match = rawText.match(frontmatterRegex);

            let metadata = {};
            let body = rawText;

            if (match) {
                const frontmatterBlock = match[1];
                body = rawText.replace(match[0], '').trim(); 
                frontmatterBlock.split('\n').forEach(line => {
                    const [key, ...value] = line.split(':');
                    if (key && value) {
                        metadata[key.trim()] = value.join(':').trim();
                    }
                });
            }

            if (!metadata.date) metadata.date = "2000-01-01";
            if (!metadata.poster) {
                const imgMatch = body.match(/!\[.*?\]\((.*?)\)/);
                if (imgMatch) metadata.poster = imgMatch[1];
            }

            return {
                ...metadata,
                bodyHTML: marked.parse(body),
                rawText: rawText.toLowerCase(),
                filename: filename,
                dateObj: new Date(metadata.date),
                monthStr: metadata.date.substring(0, 7) // "YYYY-MM"
            };
        }

        /**
         * 2. FETCHING LOGIC (Auto-Discovery)
         */
        async function init() {
            try {
                let rawData = [];

                if (USE_DEMO_MODE) {
                    rawData = getDemoData();
                } else {
                    let fileIndex = 1;
                    let keepLooking = true;
                    const MAX_FILES = 200; 

                    while (keepLooking && fileIndex <= MAX_FILES) {
                        const filename = `${FILE_PREFIX}${fileIndex}.md`;
                        try {
                            const response = await fetch(filename);
                            if (response.ok) {
                                const text = await response.text();
                                rawData.push({ filename: filename, content: text });
                                fileIndex++;
                            } else {
                                keepLooking = false;
                            }
                        } catch (e) {
                            keepLooking = false;
                        }
                    }
                }

                if (rawData.length === 0 && !USE_DEMO_MODE) {
                    container.innerHTML = `
                        <div class="col-span-full p-6 bg-red-100 border-4 border-red-800 text-red-900 font-sans text-center">
                            <h2 class="text-2xl font-bold mb-2">⚠️ No "news-x.md" Files Found</h2>
                            <p>Make sure your files are named <strong>news-1.md</strong>, <strong>news-2.md</strong>, etc.</p>
                        </div>
                    `;
                    return;
                }

                allArticles = rawData.map(item => parseArticle(item.content, item.filename));
                
                // Sort by Date Descending (Newest first), then by File Number Descending (for same-day posts)
                allArticles.sort((a, b) => {
                    // Primary: Date
                    const dateDiff = b.dateObj - a.dateObj;
                    if (dateDiff !== 0) return dateDiff;

                    // Secondary: File Number (Extract digits from filename)
                    const getNum = (name) => {
                        const match = name.match(/(\d+)/);
                        return match ? parseInt(match[0], 10) : 0;
                    };
                    return getNum(b.filename) - getNum(a.filename);
                });

                // Populate Month Filter
                const monthsSet = new Set(allArticles.map(a => a.monthStr));
                availableMonths = Array.from(monthsSet).sort().reverse();
                
                availableMonths.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month; // Could format to "February 2026"
                    monthFilter.appendChild(option);
                });

                render();

            } catch (error) {
                container.innerHTML = `<div class="col-span-full text-red-800 text-center text-2xl">Error: ${error.message}</div>`;
            }
        }

        /**
         * 3. RENDERING LOGIC
         */
        function render() {
            container.innerHTML = '';
            
            // Step A: Filter by Search Term
            let displaySet = allArticles.filter(art => {
                if (!currentSearchTerm) return true;
                return art.rawText.includes(currentSearchTerm);
            });

            // Step B: Filter by Month (Logic: Filter vs Pagination)
            let showLoadMore = false;

            if (currentSearchTerm) {
                // Search Mode: Show all matches, no pagination
                currentViewTitle.textContent = `Search Results: "${currentSearchTerm}"`;
                loadMoreBtn.classList.add('hidden');
                endMessage.classList.add('hidden');
            } 
            else if (currentFilterMonth !== 'all') {
                // Month Filter Mode: Show ONLY specific month
                displaySet = displaySet.filter(art => art.monthStr === currentFilterMonth);
                currentViewTitle.textContent = `Archives: ${currentFilterMonth}`;
                loadMoreBtn.classList.add('hidden');
                // Show end message if articles exist, otherwise empty message handles it
                endMessage.classList.toggle('hidden', displaySet.length === 0);
            } 
            else {
                // Default Pagination Mode (Show latest X months)
                currentViewTitle.textContent = "Latest News";
                
                // Get the list of months to show based on visibleMonthsCount
                const monthsToShow = availableMonths.slice(0, visibleMonthsCount);
                
                displaySet = displaySet.filter(art => monthsToShow.includes(art.monthStr));
                
                // Check if more months exist
                if (visibleMonthsCount < availableMonths.length) {
                    showLoadMore = true;
                }
            }

            // Generate HTML
            if (displaySet.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-xl italic opacity-70 py-12">No matching news found in the archives.</div>`;
                endMessage.classList.add('hidden');
                loadMoreBtn.classList.add('hidden');
            } else {
                displaySet.forEach((article, index) => {
                    const card = document.createElement('div');
                    card.className = 'sdv-box article-card';
                    card.title = "Click to read full story";
                    card.onclick = () => openModal(article); // Click to open modal
                    
                    // Poster Image
                    let imgHtml = '';
                    if (article.poster) {
                        imgHtml = `
                            <div class="article-poster-container">
                                <img src="${article.poster}" alt="News Poster" class="article-poster">
                            </div>
                        `;
                    }

                    // Format Date
                    const [y, m, d] = article.date.split('-');
                    const dateFooter = `${d}.${m}.${y}`;

                    card.innerHTML = `
                        ${imgHtml}
                        <div class="article-content-preview markdown-body">
                            ${article.bodyHTML} 
                        </div>
                        <div class="mt-2 text-center text-[#5d1616] text-sm font-bold uppercase tracking-widest opacity-60">
                            --- Click to Read More ---
                        </div>
                        <div class="newspaper-date">
                            ${dateFooter}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // Update Pagination Buttons
            if (showLoadMore) {
                loadMoreBtn.classList.remove('hidden');
                loadMoreBtn.textContent = "Read Archive";
                endMessage.classList.add('hidden');
            } else if (!currentSearchTerm && currentFilterMonth === 'all') {
                loadMoreBtn.classList.add('hidden');
                if (displaySet.length > 0) endMessage.classList.remove('hidden');
            }
        }

        /**
         * 4. MODAL LOGIC
         */
        function openModal(article) {
            const [y, m, d] = article.date.split('-');
            
            let posterHtml = '';
            if (article.poster) {
                posterHtml = `<img src="${article.poster}" class="w-full h-auto object-cover" style="image-rendering: pixelated; border: 4px solid #804022; margin-bottom: 2rem;">`;
            }

            modalContent.innerHTML = `
                <div class="text-center mb-6 pb-4 border-b-2 dashed border-[#b87030]">
                    <span class="text-xl text-[#7c5c40] italic">Stardew Valley Gazette &bull; ${d}.${m}.${y}</span>
                </div>
                ${posterHtml}
                <div class="text-xl md:text-2xl leading-relaxed text-[#4a2e18]">
                    ${article.bodyHTML}
                </div>
            `;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeModal() {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Event Listeners
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        // Escape key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        loadMoreBtn.addEventListener('click', () => {
            visibleMonthsCount++;
            render();
        });

        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.toLowerCase().trim();
            render();
        });

        monthFilter.addEventListener('change', (e) => {
            currentFilterMonth = e.target.value;
            // Reset pagination when switching back to "All Months" to restore the "Default" view
            if (currentFilterMonth === 'all') {
                visibleMonthsCount = 1;
            }
            render();
        });

        // Start
        init();

    </script>
</body>
</html>